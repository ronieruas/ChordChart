<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChordChart Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chord-output, .lyric-output, .summary-chord { font-family: 'Roboto Mono', monospace; line-height: 1.6; white-space: pre; }
        .chord-output, .summary-chord { font-weight: 700; }
        #outputArea { transition: column-count 0.3s ease-in-out; }
        .output-container.two-columns { column-count: 2; column-gap: 2.5rem; }
        .section-container { break-inside: avoid; }
        #view-wrapper { transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; margin: auto; }
        .view-tablet { width: 768px; }
        .view-mobile { width: 425px; }
        body:has(.fullscreen-view) { background-color: white !important; }
        .fullscreen-view { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: white; overflow-y: auto; z-index: 9999; padding: 2rem; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-container" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-800">Login - ChordChart Pro</h2>
            <form id="login-form"><div class="space-y-4"><div><label for="username" class="text-sm font-medium text-gray-700">Usuário</label><input id="username" name="username" type="text" required class="w-full p-2 mt-1 border border-gray-300 rounded-md shadow-sm"></div><div><label for="password" class="text-sm font-medium text-gray-700">Senha</label><input id="password" name="password" type="password" required class="w-full p-2 mt-1 border border-gray-300 rounded-md shadow-sm"></div></div><p id="login-error" class="text-sm text-red-600 mt-2 hidden">Usuário ou senha inválidos.</p><button type="submit" class="w-full px-4 py-2 mt-6 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Entrar</button></form>
        </div>
    </div>

    <div id="app-container" class="hidden flex-col lg:flex-row min-h-screen">
        <aside class="w-full lg:w-96 bg-white p-6 shadow-lg lg:h-screen lg:sticky lg:top-0 overflow-y-auto no-print">
            <div class="flex justify-between items-center"><h1 class="text-2xl font-bold text-blue-700">ChordChart Pro</h1><div class="flex items-center"><span id="welcome-user" class="text-sm text-gray-600 mr-2"></span><button id="manage-users-btn" class="p-1 text-gray-500 hover:text-blue-600 hidden" title="Gerenciar Usuários"><i class="fas fa-users-cog"></i></button><button id="change-password-btn" class="p-1 text-gray-500 hover:text-blue-600" title="Alterar Senha"><i class="fas fa-key"></i></button><button id="fullscreen-btn" class="p-1 text-gray-500 hover:text-blue-600" title="Tela Cheia"><i class="fas fa-expand"></i></button><button id="logout-btn" class="p-1 text-gray-500 hover:text-red-600" title="Sair"><i class="fas fa-sign-out-alt"></i></button></div></div>
            <p class="text-sm text-gray-500 mb-4">Sua ferramenta de cifras avançada.</p>
            <div class="mb-4"><label for="songInput" class="block text-sm font-medium text-gray-700 mb-1">Cifra Atual:</label><textarea id="songInput" rows="8" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="[Intro]&#10;G D Em C&#10;..."></textarea>
                <div class="flex gap-2 mt-2">
                    <button id="generateButton" class="flex-grow bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Gerar</button>
                    <button id="saveButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Salvar</button>
                    <button id="clearButton" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-sm">Limpar</button>
                </div>
            </div>
            <div class="flex flex-col gap-2 mb-4">
                <button id="open-songs-btn" class="w-full bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-md shadow-sm">Abrir Músicas Salvas</button>
                <button id="open-setlists-btn" class="w-full bg-indigo-700 hover:bg-indigo-800 text-white font-bold py-2 px-4 rounded-md shadow-sm">Gerenciar Setlists</button>
            </div>
            </aside>
        <main class="flex-1 p-4 sm:p-8 bg-gray-100">
            <div id="view-wrapper" class="bg-white p-8 rounded-lg shadow-inner min-h-full">
                <div id="outputArea" class="output-container"></div>
                <div id="summaryArea" class="mt-8"></div>
                <div id="uniqueChordsArea" class="mt-8"></div>
            </div>
        </main>
    </div>

    <script>
    console.log("Script de recuperação iniciado.");

    // --- DOM ELEMENTS ESSENCIAIS ---
    const dom = { 
        appContainer: document.getElementById('app-container'),
        loginContainer: document.getElementById('login-container'),
        loginForm: document.getElementById('login-form'),
        loginError: document.getElementById('login-error'),
        welcomeUser: document.getElementById('welcome-user'),
        logoutBtn: document.getElementById('logout-btn'),
        manageUsersBtn: document.getElementById('manage-users-btn'),
        changePasswordBtn: document.getElementById('change-password-btn'),
        fullscreenBtn: document.getElementById('fullscreen-btn')
    };

    // --- FUNÇÕES ESSENCIAIS DE API E AUTH ---
    async function fetchApi(path, options = {}) {
        const defaultOptions = { headers: { 'Content-Type': 'application/json' }, credentials: 'include' };
        const mergedOptions = { ...defaultOptions, ...options };
        if(options.body && typeof options.body !== 'string') mergedOptions.body = JSON.stringify(options.body);
        try { 
            const response = await fetch(path, mergedOptions); 
            if (!response.ok) { 
                if (response.status === 401) { 
                    showLoginScreen(); 
                    // Retornar um erro para que a chamada original pare
                    const errorData = await response.json().catch(() => ({error: "Não autorizado"}));
                    throw new Error(errorData.error);
                } 
                const errorData = await response.json().catch(() => ({error: "Erro desconhecido"})); 
                throw new Error(errorData.error || `HTTP error! status: ${response.status}`); 
            } 
            if (response.status === 204 || (options.method && options.method.toUpperCase() === 'DELETE') || response.status === 201) { 
                return await response.json().catch(() => ({})); 
            } 
            return await response.json(); 
        } catch (error) { 
            console.error(`API Error on ${path}:`, error); 
            throw error; 
        }
    }

    async function checkAuthStatus() { 
        try { 
            const data = await fetchApi('/api/check_auth'); 
            if (data && data.is_logged_in) { 
                showApp(data.user); 
            } else { 
                showLoginScreen(); 
            } 
        } catch (e) { 
            showLoginScreen(); 
        } 
    }
    
    async function handleLogin(event) { 
        event.preventDefault(); 
        dom.loginError.classList.add('hidden'); 
        const username = event.target.username.value; 
        const password = event.target.password.value; 
        try { 
            const data = await fetchApi('/api/login', { method: 'POST', body: { username, password } }); 
            if (data && data.user) { 
                showApp(data.user); 
            } 
        } catch (e) { 
            dom.loginError.textContent = e.message; 
            dom.loginError.classList.remove('hidden'); 
        } 
    }
    
    async function handleLogout() { 
        try {
            await fetchApi('/api/logout', { method: 'POST' }); 
        } finally {
            showLoginScreen(); 
        }
    }

    // --- FUNÇÕES ESSENCIAIS DE UI ---
    function showApp(user) { 
        console.log("showApp foi chamada com sucesso para o usuário:", user.username);
        dom.loginContainer.classList.add('hidden'); 
        dom.appContainer.classList.remove('hidden'); 
        dom.appContainer.classList.add('flex'); 
        dom.welcomeUser.textContent = `Olá, ${user.username}`; 
        
        // Apenas mostra os botões essenciais
        dom.logoutBtn.classList.remove('hidden');
        dom.fullscreenBtn.classList.remove('hidden');
        dom.changePasswordBtn.classList.remove('hidden');
        dom.manageUsersBtn.classList.toggle('hidden', !user.is_admin); 
    }

    function showLoginScreen() { 
        console.log("showLoginScreen foi chamada.");
        dom.loginContainer.classList.remove('hidden'); 
        dom.appContainer.classList.add('hidden'); 
        dom.appContainer.classList.remove('flex'); 
        // Esconde todos os botões que precisam de login
        [dom.logoutBtn, dom.fullscreenBtn, dom.changePasswordBtn, dom.manageUsersBtn].forEach(b => {
            if (b) b.classList.add('hidden');
        });
    }

    // --- INICIALIZAÇÃO ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM carregado. Adicionando listeners essenciais.");
        if (dom.loginForm) {
            dom.loginForm.addEventListener('submit', handleLogin);
        }
        if (dom.logoutBtn) {
            dom.logoutBtn.addEventListener('click', handleLogout);
        }
        checkAuthStatus();
    });

    console.log("Script de recuperação finalizado.");
    </script>
</body>
</html>