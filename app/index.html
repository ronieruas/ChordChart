<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChordChart Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chord-output, .lyric-output, .summary-chord { font-family: 'Roboto Mono', monospace; line-height: 1.6; }
        .chord-output, .summary-chord { font-weight: 700; }
        #outputArea { transition: column-count 0.3s ease-in-out; }
        .output-container.two-columns { column-count: 2; column-gap: 2.5rem; }
        .section-container { break-inside: avoid; }
        #view-wrapper { transition: all 0.3s ease-in-out; border: 1px solid #e5e7eb; margin: auto; }
        .view-tablet { width: 768px; }
        .view-mobile { width: 425px; }
        body:has(.fullscreen-view) { background-color: white !important; }
        .fullscreen-view { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: white; overflow-y: auto; z-index: 9999; padding: 2rem; }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); }
        .hidden { display: none; }
        @media print { .no-print { display: none !important; } body { background-color: white !important; margin: 0; padding: 0; } main { padding: 0 !important; } #view-wrapper { width: 100% !important; border: none !important; box-shadow: none !important; padding: 1cm !important; } #outputArea { padding: 0 !important; box-shadow: none !important; border: none !important; } .output-container.two-columns { column-count: 2 !important; } h2, h3 { color: black !important; } .chord-output, .summary-chord { color: #1e40af !important; } .lyric-output { color: #111827 !important; } }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Tela de Login -->
    <div id="login-container" class="flex items-center justify-center min-h-screen bg-gray-100">
        <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-lg shadow-md">
            <h2 class="text-2xl font-bold text-center text-gray-800">Login - ChordChart Pro</h2>
            <form id="login-form">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="text-sm font-medium text-gray-700">Usuário</label>
                        <input id="username" name="username" type="text" required class="w-full p-2 mt-1 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="password" class="text-sm font-medium text-gray-700">Senha</label>
                        <input id="password" name="password" type="password" required class="w-full p-2 mt-1 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <p id="login-error" class="text-sm text-red-600 mt-2 hidden">Usuário ou senha inválidos.</p>
                <button type="submit" class="w-full px-4 py-2 mt-6 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Container Principal da Aplicação (inicialmente oculto) -->
    <div id="app-container" class="hidden flex-col lg:flex-row min-h-screen">
        <aside class="w-full lg:w-96 bg-white p-6 shadow-lg lg:h-screen lg:sticky lg:top-0 overflow-y-auto no-print">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-blue-700">ChordChart Pro</h1>
                <div>
                    <span id="welcome-user" class="text-sm text-gray-600 mr-4"></span>
                    <button id="fullscreen-btn" class="p-1 text-gray-500 hover:text-blue-600" title="Tela Cheia"><i class="fas fa-expand"></i></button>
                    <button id="logout-btn" class="p-1 text-gray-500 hover:text-red-600" title="Sair"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
            <p class="text-sm text-gray-500 mb-6">Sua ferramenta de cifras avançada.</p>
            <div class="mb-4">
                <label for="songInput" class="block text-sm font-medium text-gray-700 mb-1">Cifra Atual:</label>
                <textarea id="songInput" rows="8" class="w-full p-2 border border-gray-300 rounded-md shadow-sm text-sm" placeholder="[Intro]&#10;G D Em C&#10;..."></textarea>
                <div class="flex gap-2 mt-2">
                    <button id="generateButton" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Gerar</button>
                    <button id="saveButton" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">Salvar</button>
                </div>
            </div>
            <div>
                 <h3 class="font-semibold text-gray-800 mb-2">Músicas Salvas</h3>
                 <div id="saved-songs-list" class="bg-gray-50 p-2 rounded-md h-40 overflow-y-auto border"></div>
            </div>
            <div class="space-y-6 mt-6">
                 <div><h3 class="font-semibold text-gray-800 mb-2">Tom da Música</h3><div class="flex items-center justify-center gap-4 bg-gray-50 p-3 rounded-md"><button id="transpose-down" class="px-3 py-1 bg-gray-300 rounded-md text-lg font-bold">-</button><div class="text-center"><span id="transpose-status" class="font-bold text-lg text-blue-600">Original</span></div><button id="transpose-up" class="px-3 py-1 bg-gray-300 rounded-md text-lg font-bold">+</button></div></div>
                 <div><h3 class="font-semibold text-gray-800 mb-2">Formatação da Cifra</h3><div class="space-y-3 bg-gray-50 p-3 rounded-md"><div class="flex items-center justify-between"><label for="lyrics-size" class="text-sm">Letra:</label><input id="lyrics-size" type="range" min="10" max="24" value="14" class="w-2/3"><input id="lyrics-color" type="color" value="#374151" class="w-8 h-8 p-0 border-none rounded"></div><div class="flex items-center justify-between"><label for="chords-size" class="text-sm">Acordes:</label><input id="chords-size" type="range" min="10" max="24" value="14" class="w-2/3"><input id="chords-color" type="color" value="#2563eb" class="w-8 h-8 p-0 border-none rounded"></div></div></div>
                 <div><h3 class="font-semibold text-gray-800 mb-2">Layout e Visualização</h3><div class="grid grid-cols-2 gap-2 bg-gray-50 p-3 rounded-md"><button id="view-mode-toggle" class="bg-gray-200 py-2 rounded-md text-sm">Ver Mapa</button><button id="columns-toggle" class="bg-gray-200 py-2 rounded-md text-sm">Usar 2 Colunas</button><button onclick="window.print()" class="col-span-2 bg-green-600 text-white hover:bg-green-700 py-2 rounded-md text-sm">Imprimir / Salvar PDF</button></div><div class="flex justify-center gap-2 mt-2 bg-gray-50 p-3 rounded-md"><button data-view="desktop" class="view-toggle-btn p-2 text-gray-500 hover:text-blue-600" title="Desktop"><i class="fas fa-desktop"></i></button><button data-view="tablet" class="view-toggle-btn p-2 text-gray-500 hover:text-blue-600" title="Tablet"><i class="fas fa-tablet-alt"></i></button><button data-view="mobile" class="view-toggle-btn p-2 text-gray-500 hover:text-blue-600" title="Mobile"><i class="fas fa-mobile-alt"></i></button></div></div>
            </div>
        </aside>
        <main class="flex-1 p-4 sm:p-8 bg-gray-100">
            <div id="view-wrapper" class="bg-white p-8 rounded-lg shadow-inner min-h-full">
                <div id="outputArea" class="output-container"></div>
                <div id="summaryArea" class="mt-8"></div>
            </div>
        </main>
    </div>

    <dialog id="save-modal" class="p-6 rounded-lg shadow-xl border"><h3 class="text-lg font-bold mb-4">Salvar Música</h3><form id="save-form"><label for="song-title-input" class="block text-sm mb-1">Título da Música:</label><input type="text" id="song-title-input" class="w-full p-2 border rounded-md" required><div class="flex justify-end gap-4 mt-6"><button type="button" id="cancel-save-btn" class="py-2 px-4 bg-gray-200 rounded-md">Cancelar</button><button type="submit" class="py-2 px-4 bg-blue-600 text-white rounded-md">Salvar</button></div></form></dialog>

    <script>
    // --- STATE MANAGEMENT ---
    const state = { songStructure: [], transposeAmount: 0, currentView: 'chart', isTwoColumns: false, ui: { lyricsSize: 14, lyricsColor: '#374151', chordsSize: 14, chordsColor: '#2563eb', viewDevice: 'desktop' } };

    // --- DOM ELEMENTS ---
    const songInput = document.getElementById('songInput');
    const generateButton = document.getElementById('generateButton');
    const saveButton = document.getElementById('saveButton');
    const outputArea = document.getElementById('outputArea');
    const summaryArea = document.getElementById('summaryArea');
    const savedSongsList = document.getElementById('saved-songs-list');
    const saveModal = document.getElementById('save-modal');
    const saveForm = document.getElementById('save-form');
    const cancelSaveBtn = document.getElementById('cancel-save-btn');
    const songTitleInput = document.getElementById('song-title-input');
    const fullscreenBtn = document.getElementById('fullscreen-btn');
    const appContainer = document.getElementById('app-container');
    const transposeStatus = document.getElementById('transpose-status');
    const loginContainer = document.getElementById('login-container');
    const loginForm = document.getElementById('login-form');
    const loginError = document.getElementById('login-error');
    const welcomeUser = document.getElementById('welcome-user');
    const logoutBtn = document.getElementById('logout-btn');

    // --- CONSTANTS & CORE LOGIC (PARSING, TRANSPOSING...) ---
    const SHARP_SCALE = ['A', 'A#', 'B', 'C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#'];
    const FLAT_SCALE =  ['A', 'Bb', 'B', 'C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab'];
    const isChordToken = (t) => t ? /^[A-Ga-g]([#b])?(m|min|M|Maj|maj|aug|dim|sus|add|Δ|°|ø)?([1-9][0-5]?)?(\((#|b)?[1-9][0-3]?((,|\s)*(#|b)?[1-9][0-3]?)*\))?(sus[24]?)?([/\\][A-Ga-g]([#b])?)?$/.test(t.trim()) : false;
    const isPotentiallyChordLine = (l) => { const t = l.trim(); return t && !/^\[.*\]$/.test(t) ? t.split(/\s+/).filter(Boolean).every(isChordToken) : false; };
    function transposeNote(n, a) { let s = n.includes('b') ? FLAT_SCALE : SHARP_SCALE; let i = s.indexOf(n); if (i===-1) return n; return s[(i+a+12)%12]; }
    function transposeChord(c, a) { if (a === 0 || !isChordToken(c)) return c; const [mc, bn] = c.split('/'); const rm = mc.match(/^[A-G](#|b)?/); if (!rm) return c; const r = rm[0]; const q = mc.substring(r.length); const nr = transposeNote(r, a); const tm = nr + q; return bn ? `${tm}/${transposeNote(bn, a)}` : tm; }
    function formatChordSequenceWithPatterns(chords, transposeAmount) { const tChords = chords.map(c => transposeChord(c, transposeAmount)); if (!tChords || tChords.length === 0) return ""; let r = [], i = 0; while (i < tChords.length) { let fp = false; for (let l = Math.floor((tChords.length - i) / 2); l >= 1; l--) { const p = tChords.slice(i, i + l); let rep = 1; while (i + (rep + 1) * l <= tChords.length) { const ns = tChords.slice(i + rep * l, i + (rep + 1) * l); if (JSON.stringify(p) === JSON.stringify(ns)) rep++; else break; } if (rep > 1) { r.push(`(${p.join(' ')}) ${rep}x`); i += rep * l; fp = true; break; } } if (!fp) { r.push(tChords[i]); i++; } } return r.join(' '); }
    function parseSong(text) { const lines = text.split('\n'), structure = []; let section = null; const create = n => ({ name: n, items: [], chordSequence: [] }); lines.forEach((l, i) => { const t = l.trim(); if (t.startsWith('[') && t.endsWith(']')) { section = create(t.substring(1, t.length - 1)); structure.push(section); return; } if (!section) { section = create('Introdução/Início'); structure.push(section); } if (t === "") { if (section.items.length > 0) section.items.push({ type: 'spacer' }); return; } if (isPotentiallyChordLine(l)) { const chords = l.trim().split(/\s+/).filter(Boolean); section.chordSequence.push(...chords); const nl = lines[i + 1] || ''; if (nl.trim() && !isPotentiallyChordLine(nl) && !nl.trim().startsWith('[')) { section.items.push({ type: 'pair', chords: l, lyrics: nl }); } else { section.items.push({ type: 'chords', chords: l }); } } else { if (i === 0 || !isPotentiallyChordLine(lines[i - 1])) { section.items.push({ type: 'lyrics', lyrics: l }); } } }); return structure.filter(s => s.items.length > 0 || s.chordSequence.length > 0); }
    
    // --- API & DATABASE FUNCTIONS ---
    async function fetchApi(path, options = {}) {
        const url = path; 
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                if (response.status === 401) { // Unauthorized
                    showLoginScreen();
                    return null; // Stop further processing
                }
                const errorText = await response.text();
                throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }
            if (response.status === 204 || (options.method && options.method.toUpperCase() === 'DELETE')) {
                return {}; 
            }
            return await response.json();
        } catch (error) {
            console.error(`API Error on ${path}:`, error);
            throw error;
        }
    }
    
    // Auth functions
    async function checkAuthStatus() {
        try {
            const data = await fetchApi('/api/check_auth');
            if (data && data.is_logged_in) {
                showApp(data.user.username);
            } else {
                showLoginScreen();
            }
        } catch (e) {
            showLoginScreen();
        }
    }

    async function handleLogin(event) {
        event.preventDefault();
        loginError.classList.add('hidden');
        const username = event.target.username.value;
        const password = event.target.password.value;
        try {
            const data = await fetchApi('/api/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            if (data) {
                showApp(data.user.username);
            } else {
                loginError.classList.remove('hidden');
            }
        } catch (e) {
            loginError.classList.remove('hidden');
        }
    }

    async function handleLogout() {
        await fetchApi('/api/logout', { method: 'POST' });
        showLoginScreen();
    }
    
    // Other API functions
    async function loadSavedSongs() { /* ... unchanged ... */ }
    async function handleLoadSong(songId) { /* ... unchanged ... */ }
    async function handleDeleteSong(songId, songTitle) { /* ... unchanged ... */ }
    async function handleSaveSong(event) { /* ... unchanged ... */ }

    // --- UI/DISPLAY LOGIC ---
    function showApp(username) {
        loginContainer.classList.add('hidden');
        appContainer.classList.remove('hidden');
        appContainer.classList.add('flex');
        welcomeUser.textContent = `Olá, ${username}`;
        loadSavedSongs();
        handleGenerate();
    }

    function showLoginScreen() {
        loginContainer.classList.remove('hidden');
        appContainer.classList.add('hidden');
        appContainer.classList.remove('flex');
    }

    // --- RENDERING LOGIC ---
    function applyStyles() { const e = document.getElementById('dynamic-styles'); if (e) e.remove(); const s = document.createElement("style"); s.id = 'dynamic-styles'; s.innerText = `.lyric-output{font-size:${state.ui.lyricsSize}px;color:${state.ui.lyricsColor};}.chord-output,.summary-chord{font-size:${state.ui.chordsSize}px;color:${state.ui.chordsColor};}`; document.head.appendChild(s); }
    function render() { if (state.songStructure.length === 0) { outputArea.innerHTML = '<p class="text-gray-500 italic">Gere uma cifra ou carregue uma música salva.</p>'; summaryArea.innerHTML = ''; return; } outputArea.innerHTML = ''; state.songStructure.forEach(s => { const d = document.createElement('div'); d.className = 'mb-6 section-container'; const h = document.createElement('h3'); h.className = 'text-lg font-bold text-gray-800 mb-2'; h.textContent = s.name; d.appendChild(h); s.items.forEach(i => { if (i.type === 'pair') { const c = i.chords.split(/\s+/).filter(Boolean).map(c => transposeChord(c, state.transposeAmount)).join(' '); const cd = document.createElement('div'); cd.className = 'chord-output whitespace-pre-wrap'; cd.textContent = c.padEnd(i.chords.length); const ld = document.createElement('div'); ld.className = 'lyric-output whitespace-pre-wrap'; ld.textContent = i.lyrics; d.appendChild(cd); d.appendChild(ld); } else if (i.type === 'chords') { const c = i.chords.split(/\s+/).filter(Boolean).map(c => transposeChord(c, state.transposeAmount)).join(' '); const cd = document.createElement('div'); cd.className = 'chord-output whitespace-pre-wrap mb-2'; cd.textContent = c; d.appendChild(cd); } else if (i.type === 'lyrics') { const ld = document.createElement('div'); ld.className = 'lyric-output whitespace-pre-wrap'; ld.textContent = i.lyrics; d.appendChild(ld); } else if (i.type === 'spacer') { const sd = document.createElement('div'); sd.className = 'h-4'; d.appendChild(sd); } }); if (state.currentView === 'map') { const b = document.createElement('div'); b.className = 'mt-3 p-2 bg-gray-50 rounded-md text-sm'; const t = formatChordSequenceWithPatterns(s.chordSequence, state.transposeAmount); b.innerHTML = `<span class="font-semibold text-gray-600">Sequência:</span> <span class="summary-chord">${t}</span>`; d.appendChild(b); } outputArea.appendChild(d); }); summaryArea.innerHTML = ''; const st = document.createElement('h2'); st.className = 'text-xl font-bold text-gray-800 mb-2 mt-4 border-t pt-4'; st.textContent = 'Estrutura Completa da Música'; const sc = document.createElement('div'); sc.className = 'p-4 bg-blue-50 rounded-lg text-sm leading-relaxed'; sc.innerHTML = state.songStructure.filter(s => s.chordSequence.length > 0).map(s => `<strong class="text-blue-800">[${s.name}]</strong> <span class="summary-chord">(${formatChordSequenceWithPatterns(s.chordSequence, state.transposeAmount)})</span>`).join(' <span class="font-bold text-blue-400">&rarr;</span> '); summaryArea.appendChild(st); summaryArea.appendChild(sc); applyStyles(); }

    // --- UI EVENT HANDLERS ---
    function handleGenerate() { state.songStructure = parseSong(songInput.value); state.transposeAmount = 0; updateTransposeStatus(); render(); }
    function handleTranspose(a) { state.transposeAmount += a; updateTransposeStatus(); render(); }
    function updateTransposeStatus() { transposeStatus.textContent = state.transposeAmount === 0 ? 'Original' : `${state.transposeAmount > 0 ? '+' : ''}${state.transposeAmount}`; }
    function handleStyleChange(k, v) { state.ui[k] = v; applyStyles(); }
    function handleViewModeToggle() { state.currentView = state.currentView === 'chart' ? 'map' : 'chart'; viewModeToggle.textContent = state.currentView === 'chart' ? 'Ver Mapa' : 'Ver Cifra'; render(); }
    function handleColumnsToggle() { state.isTwoColumns = !state.isTwoColumns; outputArea.classList.toggle('two-columns', state.isTwoColumns); columnsToggle.textContent = state.isTwoColumns ? 'Usar 1 Coluna' : 'Usar 2 Colunas'; }
    function handleDeviceViewToggle(d) { viewWrapper.classList.remove('view-desktop', 'view-tablet', 'view-mobile'); if (d !== 'desktop') { viewWrapper.classList.add(`view-${d}`); } }
    function toggleFullscreen() { if (!document.fullscreenElement) { appContainer.requestFullscreen().catch(err => alert(`Erro ao entrar em tela cheia: ${err.message}`)); } else { document.exitFullscreen(); } }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const transposeUpBtn = document.getElementById('transpose-up');
        const transposeDownBtn = document.getElementById('transpose-down');
        const lyricsSizeSlider = document.getElementById('lyrics-size');
        const chordsSizeSlider = document.getElementById('chords-size');
        const lyricsColorPicker = document.getElementById('lyrics-color');
        const chordsColorPicker = document.getElementById('chords-color');
        const viewModeToggle = document.getElementById('view-mode-toggle');
        const columnsToggle = document.getElementById('columns-toggle');

        loginForm.addEventListener('submit', handleLogin);
        logoutBtn.addEventListener('click', handleLogout);

        generateButton.addEventListener('click', handleGenerate);
        transposeUpBtn.addEventListener('click', () => handleTranspose(1));
        transposeDownBtn.addEventListener('click', () => handleTranspose(-1));
        lyricsSizeSlider.addEventListener('input', (e) => handleStyleChange('lyricsSize', e.target.value));
        chordsSizeSlider.addEventListener('input', (e) => handleStyleChange('chordsSize', e.target.value));
        lyricsColorPicker.addEventListener('input', (e) => handleStyleChange('lyricsColor', e.target.value));
        chordsColorPicker.addEventListener('input', (e) => handleStyleChange('chordsColor', e.target.value));
        viewModeToggle.addEventListener('click', handleViewModeToggle);
        columnsToggle.addEventListener('click', handleColumnsToggle);
        document.querySelectorAll('.view-toggle-btn').forEach(b => b.addEventListener('click', e => handleDeviceViewToggle(e.currentTarget.dataset.view)));
        
        fullscreenBtn.addEventListener('click', toggleFullscreen);
        document.addEventListener('fullscreenchange', () => appContainer.classList.toggle('fullscreen-view', !!document.fullscreenElement));
        saveButton.addEventListener('click', () => { if (songInput.value.trim()) { saveModal.showModal(); } else { alert("Por favor, cole uma cifra antes de salvar."); } });
        cancelSaveBtn.addEventListener('click', () => saveModal.close());
        saveForm.addEventListener('submit', handleSaveSong);
        
        if (songInput.value.trim() === "") {
            songInput.value = `[Intro]\nG D Em C\nG D Em C\n\n[Verso 1]\nG              D\nVim para adorar-te\nEm             C\nVim para prostrar-me\nG              D           C\nVim para dizer que és meu Deus\n\n[Refrão]\nG           D/F#\nÉs totalmente amável\nEm          C\nTotalmente digno\nG         D/F#         C\nTão maravilhoso para mim`;
        }
        
        checkAuthStatus(); // Check login status when the page loads
    });
    </script>
</body>
</html>